<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H.C.S | School Office Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #005fa3;
      --secondary-color: #004080;
      --accent-color: #00a8e8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background: #f0f2f5; color: var(--dark-color); }
    header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1.5rem; text-align: center; box-shadow: var(--box-shadow); }
    nav { background: var(--secondary-color); padding: 0.75rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    nav a { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: var(--border-radius); transition: var(--transition); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    nav a:hover, nav a.active { background: var(--accent-color); }

    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .card { background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; margin-bottom: 2rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.9rem; }
    input, select { width: 100%; padding: 0.65rem; border: 1px solid #ddd; border-radius: var(--border-radius); outline: none; transition: var(--transition); }
    input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0,95,163,0.1); }
    
    .btn { padding: 0.65rem 1.2rem; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-info { background: var(--info-color); color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.85rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; color: var(--secondary-color); font-weight: 600; }
    tr.total-row { background: #e9ecef; font-weight: bold; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
    
    .receipt-preview { padding: 2rem; border: 2px solid #eee; background: white; width: 100%; max-width: 400px; margin: 0 auto; font-family: 'Courier New', Courier, monospace; }
    
    .term-switcher { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem; }
    .term-btn { padding: 0.4rem 1rem; border: 1px solid var(--primary-color); background: white; color: var(--primary-color); border-radius: 20px; cursor: pointer; }
    .term-btn.active { background: var(--primary-color); color: white; }

    @media print {
      body * { visibility: hidden; }
      .receipt-preview, .receipt-preview * { visibility: visible; }
      .receipt-preview { position: absolute; left: 0; top: 0; width: 100%; border: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Heriwadi Christian Schools Ltd</h1>
    <p>Financial Management System</p>
  </header>
  
  <nav>
    <a href="index.html"><i class="fas fa-home"></i> Dashboard</a>
    <a href="receipts.html" class="active"><i class="fas fa-receipt"></i> Receipts</a>
    <a href="expense.html"><i class="fas fa-money-bill-wave"></i> Expenses</a>
    <a href="assets.html"><i class="fas fa-laptop-house"></i> Assets</a>
    <a href="staff.html"><i class="fas fa-user-tie"></i> Staff</a>
    <a href="students.html"><i class="fas fa-users"></i> Students</a>
    <a href="payroll.html"><i class="fas fa-money-check-alt"></i> Payroll</a>
    <a href="financials.html"><i class="fas fa-chart-line"></i> Financials</a>
  </nav>

  <div class="container">
    <div class="term-switcher">
        <button class="term-btn active" onclick="setTerm(1, this)">Term 1</button>
        <button class="term-btn" onclick="setTerm(2, this)">Term 2</button>
        <button class="term-btn" onclick="setTerm(3, this)">Term 3</button>
    </div>

    <div class="grid">
        <div class="card">
            <h3><i class="fas fa-plus-circle"></i> Issue New Receipt</h3>
            <hr style="margin: 1rem 0; opacity: 0.1;">
            <form id="receiptForm">
                <div class="form-group">
                    <label>Select Student</label>
                    <select id="studentSelect" required onchange="updateStudentInfo()">
                        <option value="">-- Choose Student --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount Paid (KES)</label>
                    <input type="number" id="amountPaid" required placeholder="0.00" />
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option>M-Pesa</option>
                        <option>Bank Deposit</option>
                        <option>Cash</option>
                        <option>Cheque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference / Transaction ID</label>
                    <input type="text" id="refNo" placeholder="Optional" />
                </div>
                <button type="submit" class="btn btn-success" style="width:100%"><i class="fas fa-print"></i> Save & Generate Receipt</button>
            </form>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="fas fa-wallet"></i> Quick Balance Check</h3>
                <button class="btn btn-primary btn-sm" onclick="openStudentManager()">Manage Students</button>
            </div>
            <hr style="margin: 1rem 0; opacity: 0.1;">
            <div id="balanceList" style="max-height: 300px; overflow-y: auto;">
                </div>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-history"></i> Recent Transactions - Term <span id="termDisplay">1</span></h3>
        <table id="receiptsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Student</th>
                    <th>Ref</th>
                    <th>Method</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="receiptsBody"></tbody>
        </table>
    </div>
  </div>

  <div id="studentManagerModal" class="modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Student & Fee Structure Manager</h2>
            <button class="btn btn-danger" onclick="closeStudentManager()">X</button>
        </div>
        <hr style="margin: 1rem 0;">
        <form id="studentForm">
            <div class="grid">
                <input type="text" id="studentName" placeholder="Full Name" required />
                <select id="studentClass">
                    <option>Play Group</option><option>PP1</option><option>PP2</option>
                    <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
                    <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
                </select>
                <input type="text" id="phone" placeholder="Parent Phone" />
            </div>
            <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="form-group"><label>Tuition</label><input type="number" id="tuition" value="0"/></div>
                <div class="form-group"><label>Admission</label><input type="number" id="adm" value="0"/></div>
                <div class="form-group"><label>Assessment Fee</label><input type="number" id="assessment" value="0"/></div>
                <div class="form-group"><label>Medical</label><input type="number" id="medical" value="0"/></div>
                <div class="form-group"><label>Lunch</label><input type="number" id="lunch" value="0"/></div>
                <div class="form-group"><label>Uniform</label><input type="number" id="uniform" value="0"/></div>
                <div class="form-group"><label>Transport</label><input type="number" id="transport" value="0"/></div>
                <div class="form-group"><label>Trip</label><input type="number" id="trip" value="0"/></div>
                <div class="form-group"><label>Graduation</label><input type="number" id="graduation" value="0"/></div>
            </div>
            <button type="submit" class="btn btn-success">Add Student</button>
        </form>
        <hr style="margin: 2rem 0;">
        <table id="managerTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Class</th>
                    <th>Total Fee</th>
                    <th>Paid</th>
                    <th>Bal</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="managerBody"></tbody>
            <tfoot id="managerFoot"></tfoot>
        </table>
    </div>
  </div>

  <div id="receiptModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <div class="receipt-preview" id="receiptPrintArea">
            <div style="text-align: center;">
                <h2 style="font-size: 1.2rem;">HERIWADI CHRISTIAN SCHOOLS</h2>
                <p style="font-size: 0.8rem;">P.O. Box 12345-00100, Nairobi</p>
                <p style="font-size: 0.8rem;">Tel: +254 700 000 000</p>
                <p>-------------------------</p>
                <h3 style="margin: 0.5rem 0;">OFFICIAL RECEIPT</h3>
            </div>
            <div style="font-size: 0.9rem; margin-top: 1rem;">
                <p><strong>Receipt No:</strong> <span id="rNo"></span></p>
                <p><strong>Date:</strong> <span id="rDate"></span></p>
                <p><strong>Student:</strong> <span id="rStudent"></span></p>
                <p><strong>Class:</strong> <span id="rClass"></span></p>
                <p>-------------------------</p>
                <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                    <span>Payment Method:</span><span id="rMethod"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                    <span>Ref/Trans ID:</span><span id="rRef"></span>
                </div>
                <p>-------------------------</p>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem;">
                    <span>TOTAL PAID:</span><span>KES <span id="rAmount"></span></span>
                </div>
                <p>-------------------------</p>
                <div style="display: flex; justify-content: space-between;">
                    <span>Fee Balance:</span><span>KES <span id="rBal"></span></span>
                </div>
                <p style="margin-top: 2rem; text-align: center; font-style: italic; font-size: 0.8rem;">Thank you for choosing Heriwadi Christian Schools.</p>
            </div>
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" style="flex:1" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
            <button class="btn btn-danger" style="flex:1" onclick="document.getElementById('receiptModal').classList.remove('show')">Close</button>
        </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAA6zY40EwbTmWUx1op1cx52C3y0RK3m0",
      authDomain: "heriwadi-manager.firebaseapp.com",
      projectId: "heriwadi-manager",
      storageBucket: "heriwadi-manager.appspot.com",
      messagingSenderId: "654632910809",
      appId: "1:654632910809:web:7c65613d2510402a6663c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentTerm = 1;
    let currentYear = new Date().getFullYear();

    const getStudentsColl = () => db.collection(`students_${currentYear}_term_${currentTerm}`);
    const getReceiptsColl = () => db.collection(`receipts_${currentYear}_term_${currentTerm}`);

    function setTerm(t, btn) {
        currentTerm = t;
        document.querySelectorAll('.term-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('termDisplay').innerText = t;
        updateUI();
    }

    async function updateUI() {
        populateStudents();
        loadReceipts();
    }

    async function populateStudents() {
        const snap = await getStudentsColl().orderBy('name').get();
        const select = document.getElementById('studentSelect');
        const balList = document.getElementById('balanceList');
        const managerBody = document.getElementById('managerBody');
        const managerFoot = document.getElementById('managerFoot');
        
        select.innerHTML = '<option value="">-- Choose Student --</option>';
        balList.innerHTML = '';
        managerBody.innerHTML = '';
        managerFoot.innerHTML = '';

        let totalSchoolBalance = 0;

        snap.forEach(doc => {
            const s = doc.data();
            // Calculation Fix: Bal = Total Items - Paid Amount
            const balance = (s.total || 0) - (s.paid || 0);
            totalSchoolBalance += balance;

            // Forms
            select.innerHTML += `<option value="${doc.id}">${s.name} (${s.class})</option>`;
            
            // Side list
            const div = document.createElement('div');
            div.style = "display:flex; justify-content:space-between; padding:0.5rem; border-bottom:1px solid #f0f0f0;";
            div.innerHTML = `<span>${s.name}</span><span style="color:${balance > 0 ? 'red' : 'green'}">KES ${balance.toLocaleString()}</span>`;
            balList.appendChild(div);

            // Manager Table
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${s.name}</td>
                <td>${s.class}</td>
                <td>${(s.total || 0).toLocaleString()}</td>
                <td>${(s.paid || 0).toLocaleString()}</td>
                <td style="font-weight:bold; color:${balance > 0 ? 'var(--danger-color)' : 'var(--success-color)'}">${balance.toLocaleString()}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteStudent('${doc.id}')"><i class="fas fa-trash"></i></button></td>
            `;
            managerBody.appendChild(row);
        });

        // Add Total Balance Row to Table Footer
        if (!snap.empty) {
            managerFoot.innerHTML = `
                <tr class="total-row">
                    <td colspan="4" style="text-align:right">GRAND TOTAL FEE BALANCE:</td>
                    <td style="color:var(--danger-color)">KES ${totalSchoolBalance.toLocaleString()}</td>
                    <td></td>
                </tr>
            `;
        }
    }

    async function loadReceipts() {
        const snap = await getReceiptsColl().orderBy('timestamp', 'desc').limit(20).get();
        const container = document.getElementById('receiptsBody');
        container.innerHTML = '';
        snap.forEach(doc => {
            const r = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${r.date}</td>
                <td>${r.studentName}</td>
                <td>${r.refNo || '-'}</td>
                <td>${r.method}</td>
                <td><strong>${r.amount.toLocaleString()}</strong></td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="reprintReceipt('${doc.id}')"><i class="fas fa-print"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteReceipt('${doc.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            container.appendChild(row);
        });
    }

    document.getElementById('receiptForm').onsubmit = async (e) => {
        e.preventDefault();
        const studentId = document.getElementById('studentSelect').value;
        const amount = parseFloat(document.getElementById('amountPaid').value);
        const method = document.getElementById('paymentMethod').value;
        const refNo = document.getElementById('refNo').value;

        if(!studentId) return alert("Select a student");

        const studentRef = getStudentsColl().doc(studentId);
        const sDoc = await studentRef.get();
        const sData = sDoc.data();

        const newPaid = (sData.paid || 0) + amount;
        const newBalance = (sData.total || 0) - newPaid;

        const receiptData = {
            studentId,
            studentName: sData.name,
            class: sData.class,
            amount,
            method,
            refNo,
            balanceAfter: newBalance,
            date: new Date().toLocaleDateString(),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        const rRef = await getReceiptsColl().add(receiptData);
        await studentRef.update({ paid: newPaid, balance: newBalance });

        showReceipt(rRef.id, receiptData);
        document.getElementById('receiptForm').reset();
        updateUI();
    };

    function showReceipt(id, data) {
        document.getElementById('rNo').innerText = id.substring(0,8).toUpperCase();
        document.getElementById('rDate').innerText = data.date;
        document.getElementById('rStudent').innerText = data.studentName;
        document.getElementById('rClass').innerText = data.class;
        document.getElementById('rMethod').innerText = data.method;
        document.getElementById('rRef').innerText = data.refNo || 'N/A';
        document.getElementById('rAmount').innerText = data.amount.toLocaleString();
        document.getElementById('rBal').innerText = data.balanceAfter.toLocaleString();
        document.getElementById('receiptModal').classList.add('show');
    }

    async function reprintReceipt(id) {
        const doc = await getReceiptsColl().doc(id).get();
        showReceipt(id, doc.data());
    }

    async function deleteReceipt(id) {
        if(!confirm("Delete this transaction? This will NOT reverse the student's balance automatically.")) return;
        await getReceiptsColl().doc(id).delete();
        updateUI();
    }

    function openStudentManager() { document.getElementById('studentManagerModal').classList.add('show'); }
    function closeStudentManager() { document.getElementById('studentManagerModal').classList.remove('show'); }

    document.getElementById('studentForm').onsubmit = async (e) => {
        e.preventDefault();
        // Updated items: Added assessment, removed stationary & books
        const fields = ['tuition','adm','assessment','medical','lunch','uniform','transport','trip','graduation'];
        let total = 0; 
        let data = {
            name: document.getElementById('studentName').value,
            class: document.getElementById('studentClass').value,
            phone: document.getElementById('phone').value,
            paid: 0, 
            term: currentTerm, 
            year: currentYear
        };
        fields.forEach(f => {
            let val = parseFloat(document.getElementById(f).value) || 0;
            data[f] = val; 
            total += val;
        });
        
        data.total = total; 
        // Initial balance = total items minus 0 paid
        data.balance = total; 

        await getStudentsColl().add(data);
        alert("Student Added");
        document.getElementById('studentForm').reset();
        populateStudents();
    };

    async function deleteStudent(id) {
        if(!confirm("Are you sure? All records for this student will be lost.")) return;
        await getStudentsColl().doc(id).delete();
        populateStudents();
    }

    window.onload = updateUI;
  </script>
</body>
</html>
