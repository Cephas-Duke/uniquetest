<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Dashboard | Heriwadi Christian Schools</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #005fa3;
      --secondary-color: #004080;
      --accent-color: #00a8e8;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; color: #333; line-height: 1.6; }

    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    nav {
      background: var(--secondary-color);
      padding: 0.75rem 1.5rem;
      display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;
      box-shadow: var(--box-shadow);
    }

    nav a {
      color: white; text-decoration: none; padding: 0.5rem 1rem;
      border-radius: var(--border-radius); transition: var(--transition);
      display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem;
    }

    nav a:hover { background: var(--accent-color); transform: translateY(-2px); }
    nav a.active { background: var(--accent-color); font-weight: bold; }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

    .dashboard-header {
      background: white; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); padding: 1.5rem; margin-bottom: 1.5rem;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
    }

    .admin-panel {
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
      color: white; padding: 1rem; border-radius: var(--border-radius);
      margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;
    }

    .year-status-badge {
      padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: bold; font-size: 0.9rem;
      text-transform: uppercase;
    }
    .status-open { background-color: #28a745; color: white; }
    .status-closed { background-color: #dc3545; color: white; }

    .btn {
      padding: 0.5rem 1rem; border: none; border-radius: var(--border-radius);
      cursor: pointer; transition: var(--transition); display: inline-flex;
      align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 500;
    }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-warning { background: var(--warning-color); color: #333; }

    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem; margin-bottom: 2rem;
    }

    .stat-card {
      background: white; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); padding: 1.5rem;
    }

    .stat-value { font-size: 1.8rem; font-weight: bold; margin: 0.5rem 0; }
    .positive { color: var(--success-color); }
    .negative { color: var(--danger-color); }

    /* Department Sections */
    .department-section {
      background: white; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); margin-bottom: 1.5rem; overflow: hidden;
    }
    .department-header {
      padding: 1rem 1.5rem; background: var(--primary-color); color: white;
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .department-content { padding: 1.5rem; display: none; }
    .department-content.active { display: block; }

    .transactions-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .transactions-table th, .transactions-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
    .transactions-table th { background: #f8f9fa; }

    /* Modals */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white; border-radius: var(--border-radius); width: 90%; max-width: 500px;
      padding: 1.5rem; position: relative;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .report-option {
      display: block; padding: 1rem; border: 1px solid #ddd; border-radius: var(--border-radius);
      margin-bottom: 0.5rem; cursor: pointer; transition: 0.2s;
    }
    .report-option:hover { background-color: #f0f8ff; border-color: var(--primary-color); }
    .report-option i { font-size: 1.5rem; color: var(--primary-color); margin-right: 1rem; }

    .status-message {
      padding: 10px; margin: 10px 0; border-radius: 5px; display: none;
    }
    .status-message.active { display: block; }
    .status-info { background: #d1ecf1; color: #0c5460; }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Heriwadi Christian Schools Ltd</h1>
    <p>Financial Management Dashboard</p>
  </header>

  <nav>
    <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="receipts.html"><i class="fas fa-receipt"></i> Receipts</a>
    <a href="students.html"><i class="fas fa-users"></i> Students</a>
    <a href="expense.html"><i class="fas fa-money-bill-wave"></i> Expenses</a>
    <a href="assets.html"><i class="fas fa-laptop-house"></i> Assets</a>
    <a href="staff.html"><i class="fas fa-user-tie"></i> Staff</a>
    <a href="payroll.html"><i class="fas fa-money-check-alt"></i> Payroll</a>
    <a href="financials.html" class="active"><i class="fas fa-chart-line"></i> Financial</a>
  </nav>

  <div class="container">
    
    <div class="admin-panel">
      <div>
        <h3><i class="fas fa-shield-alt"></i> Admin Control: Financial Year <span id="displayYear">2024</span></h3>
        <span id="yearStatusBadge" class="year-status-badge status-open">Open</span>
      </div>
      <div>
        <button class="btn btn-danger" id="closeYearBtn" onclick="confirmCloseYear()">
          <i class="fas fa-lock"></i> Close Financial Year
        </button>
      </div>
    </div>

    <div class="dashboard-header">
      <h2 class="dashboard-title">
        Term <span id="currentTermDisplay">2</span> Overview
      </h2>
      <div class="refresh-controls">
        <button class="btn btn-primary" onclick="refreshAllData()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-success" onclick="openReportModal()">
          <i class="fas fa-file-invoice-dollar"></i> Generate Reports
        </button>
      </div>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div style="margin-bottom: 20px; text-align: center;">
      <button class="btn btn-primary" onclick="switchTerm(1)">Term 1</button>
      <button class="btn btn-primary" onclick="switchTerm(2)">Term 2</button>
      <button class="btn btn-primary" onclick="switchTerm(3)">Term 3</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Net Bank Balance</div>
        <div class="stat-value" id="bankBalance">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Income (Term)</div>
        <div class="stat-value positive" id="termIncome">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Expenses (Term)</div>
        <div class="stat-value negative" id="termExpenses">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Net Profit/Loss</div>
        <div class="stat-value" id="netProfit">KES 0</div>
      </div>
    </div>

    <div class="department-section">
      <div class="department-header" onclick="toggleSection('bank')">
        <h3><i class="fas fa-university"></i> Bank Transactions</h3>
        <i class="fas fa-chevron-down" id="bankChevron"></i>
      </div>
      <div class="department-content active" id="bankContent">
        <table class="transactions-table">
          <thead>
            <tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Balance</th></tr>
          </thead>
          <tbody id="bankTransactionsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
      <canvas id="profitLossChart" style="max-height: 400px;"></canvas>
    </div>

  </div>

  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Select Report Type</h3>
        <button class="btn btn-warning" onclick="closeReportModal()">X</button>
      </div>
      <div class="modal-body">
        <div class="report-option" onclick="generateAccountantReport()">
          <div style="display: flex; align-items: center;">
            <i class="fas fa-calculator"></i>
            <div>
              <strong>Accountant's Pack</strong>
              <div style="font-size: 0.8rem; color: #666;">Detailed ledgers, breakdown by category (Transport, Food, etc.), and bank reconciliation data.</div>
            </div>
          </div>
        </div>
        
        <div class="report-option" onclick="generateTaxReport()">
          <div style="display: flex; align-items: center;">
            <i class="fas fa-landmark"></i>
            <div>
              <strong>Tax Authority (KRA) Summary</strong>
              <div style="font-size: 0.8rem; color: #666;">Annual consolidated report. Gross Income vs Deductible Expenses for the full year.</div>
            </div>
          </div>
        </div>

        <div class="report-option" onclick="exportFinancialReport()">
          <div style="display: flex; align-items: center;">
            <i class="fas fa-table"></i>
            <div>
              <strong>Current View Dump</strong>
              <div style="font-size: 0.8rem; color: #666;">Simple export of what is currently visible on the dashboard.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBAA6zY40EwbTmWUx1op1cx52C3y0RK3m0",
      authDomain: "heriwadi-manager.firebaseapp.com",
      projectId: "heriwadi-manager",
      storageBucket: "heriwadi-manager.appspot.com",
      messagingSenderId: "654632910809",
      appId: "1:654632910809:web:7c65613d2510402a6663c8",
      measurementId: "G-LLHS6GLB6E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // State
    let currentTerm = parseInt(sessionStorage.getItem('heriwadi_current_term')) || 2;
    let currentYear = new Date().getFullYear();
    let financialData = { receipts: [], expenses: [], bankTransactions: [] };
    let isYearClosed = false;

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('displayYear').textContent = currentYear;
      document.getElementById('currentTermDisplay').textContent = currentTerm;
      checkYearStatus();
      loadAllFinancialData();
    });

    function showStatus(msg, type='info') {
      const el = document.getElementById('statusMessage');
      el.textContent = msg;
      el.className = `status-message status-${type} active`;
      setTimeout(() => el.classList.remove('active'), 4000);
    }

    function switchTerm(term) {
      currentTerm = term;
      document.getElementById('currentTermDisplay').textContent = term;
      loadAllFinancialData();
    }

    function toggleSection(id) {
      document.getElementById(id+'Content').classList.toggle('active');
    }

    // ==========================================
    // 1. FINANCIAL YEAR LOCKING LOGIC
    // ==========================================
    async function checkYearStatus() {
      try {
        const doc = await db.collection('system_settings').doc('financial_years').get();
        if (doc.exists) {
          const data = doc.data();
          const status = data[currentYear] || 'open';
          isYearClosed = (status === 'closed');
          updateAdminPanelUI();
        }
      } catch (e) {
        console.error("Error checking year status", e);
      }
    }

    function updateAdminPanelUI() {
      const badge = document.getElementById('yearStatusBadge');
      const btn = document.getElementById('closeYearBtn');
      
      if (isYearClosed) {
        badge.textContent = "CLOSED / READ-ONLY";
        badge.className = "year-status-badge status-closed";
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-lock"></i> Year Locked';
        showStatus(`Financial Year ${currentYear} is Closed. Editing is disabled.`, "error");
      } else {
        badge.textContent = "OPEN";
        badge.className = "year-status-badge status-open";
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Close Financial Year';
      }
    }

    async function confirmCloseYear() {
      if(!confirm(`⚠️ WARNING: You are about to CLOSE Financial Year ${currentYear}.\n\nThis will:\n1. Lock all receipts and expenses for this year.\n2. Prevent further editing.\n\nAre you sure?`)) return;
      
      const password = prompt("Please enter admin password to confirm:");
      if(password !== "admin2025") { // Replace with your real check logic
        alert("Incorrect password.");
        return;
      }

      try {
        await db.collection('system_settings').doc('financial_years').set({
          [currentYear]: 'closed'
        }, { merge: true });
        
        isYearClosed = true;
        updateAdminPanelUI();
        alert(`Financial Year ${currentYear} has been successfully closed.`);
      } catch(e) {
        alert("Error closing year: " + e.message);
      }
    }

    // ==========================================
    // 2. DATA LOADING
    // ==========================================
    async function loadAllFinancialData() {
      showStatus("Loading financial data...", "info");
      financialData = { receipts: [], expenses: [], bankTransactions: [] }; // Reset

      try {
        // Load Receipts
        const rSnap = await db.collection(`receipts_${currentYear}_term_${currentTerm}`).get();
        rSnap.forEach(doc => financialData.receipts.push(doc.data()));

        // Load Expenses (assuming they are stored by term or have a term field)
        // If your expenses are in one big collection, we filter in memory
        const eSnap = await db.collection('expenses').get(); 
        eSnap.forEach(doc => {
          const d = doc.data();
          // Simple check if expense belongs to this term/year
          if(getTermFromDate(d.date) === currentTerm && new Date(d.date).getFullYear() === currentYear) {
            financialData.expenses.push(d);
          }
        });

        processFinancials();
        showStatus("Data updated successfully", "success");
      } catch (e) {
        console.error(e);
        showStatus("Error loading data: " + e.message, "error");
      }
    }

    function getTermFromDate(dateString) {
      // Simple helper logic - customize based on your school months
      const month = new Date(dateString).getMonth() + 1;
      if (month <= 4) return 1;
      if (month <= 8) return 2;
      return 3;
    }

    function processFinancials() {
      let income = 0;
      let expense = 0;
      const transactions = [];

      // Process Income
      financialData.receipts.forEach(r => {
        income += (r.paid || 0);
        transactions.push({
          date: r.date,
          desc: `Fee Payment: ${r.name}`,
          type: 'Credit',
          amount: r.paid || 0
        });
      });

      // Process Expenses
      financialData.expenses.forEach(e => {
        expense += (e.amount || 0);
        transactions.push({
          date: e.date,
          desc: `Expense: ${e.description} (${e.category})`,
          type: 'Debit',
          amount: e.amount || 0
        });
      });

      // Sort by date
      transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

      // Calculate Running Balance
      let bal = 0;
      transactions.forEach(t => {
        if(t.type === 'Credit') bal += t.amount;
        else bal -= t.amount;
        t.balance = bal;
      });

      financialData.bankTransactions = transactions;

      // Update UI
      document.getElementById('bankBalance').textContent = `KES ${bal.toLocaleString()}`;
      document.getElementById('termIncome').textContent = `KES ${income.toLocaleString()}`;
      document.getElementById('termExpenses').textContent = `KES ${expense.toLocaleString()}`;
      document.getElementById('netProfit').textContent = `KES ${(income - expense).toLocaleString()}`;
      
      if((income - expense) >= 0) {
        document.getElementById('netProfit').className = "stat-value positive";
      } else {
        document.getElementById('netProfit').className = "stat-value negative";
      }

      renderTransactionsTable();
      renderChart(income, expense);
    }

    function renderTransactionsTable() {
      const tbody = document.getElementById('bankTransactionsTable');
      tbody.innerHTML = '';
      // Show last 10
      const recent = financialData.bankTransactions.slice().reverse().slice(0, 20);
      
      recent.forEach(t => {
        const row = `<tr>
          <td>${new Date(t.date).toLocaleDateString()}</td>
          <td>${t.desc}</td>
          <td style="color:${t.type === 'Credit' ? 'green' : 'red'}">${t.type}</td>
          <td>${t.amount.toLocaleString()}</td>
          <td>${t.balance.toLocaleString()}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function renderChart(inc, exp) {
      const ctx = document.getElementById('profitLossChart').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses', 'Net Profit'],
          datasets: [{
            label: `Term ${currentTerm} Financials`,
            data: [inc, exp, inc - exp],
            backgroundColor: ['#28a745', '#dc3545', '#005fa3']
          }]
        }
      });
    }

    // ==========================================
    // 3. ADVANCED REPORTING
    // ==========================================
    
    function openReportModal() { document.getElementById('reportModal').classList.add('show'); }
    function closeReportModal() { document.getElementById('reportModal').classList.remove('show'); }

    // 3A. ACCOUNTANT REPORT (Detailed)
    async function generateAccountantReport() {
      showStatus("Generating Accountant Pack...", "info");
      const wb = XLSX.utils.book_new();

      // Sheet 1: Summary
      const summaryData = [
        ["Heriwadi Schools - Accountant Report", `Year: ${currentYear} | Term: ${currentTerm}`],
        [],
        ["Category", "Amount"],
        ["Total Fee Income", document.getElementById('termIncome').textContent],
        ["Total Operational Expenses", document.getElementById('termExpenses').textContent],
        ["Net Position", document.getElementById('netProfit').textContent]
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), "Executive Summary");

      // Sheet 2: Ledger (Bank Transactions)
      const ledgerData = financialData.bankTransactions.map(t => ({
        Date: new Date(t.date).toLocaleDateString(),
        Description: t.desc,
        Type: t.type,
        Debit: t.type === 'Debit' ? t.amount : 0,
        Credit: t.type === 'Credit' ? t.amount : 0,
        RunningBalance: t.balance
      }));
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ledgerData), "General Ledger");

      // Sheet 3: Expense Breakdown
      // Group expenses by category
      const expenseGroups = {};
      financialData.expenses.forEach(e => {
        if(!expenseGroups[e.category]) expenseGroups[e.category] = 0;
        expenseGroups[e.category] += (e.amount || 0);
      });
      
      const expenseData = Object.keys(expenseGroups).map(cat => ({
        Category: cat,
        TotalAmount: expenseGroups[cat]
      }));
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenseData), "Expense Breakdown");

      XLSX.writeFile(wb, `Accountant_Report_${currentYear}_Term${currentTerm}.xlsx`);
      closeReportModal();
      showStatus("Report Downloaded", "success");
    }

    // 3B. TAX REPORT (Annual)
    async function generateTaxReport() {
      if(!confirm("This will fetch data for the WHOLE YEAR to generate a tax summary. This might take a moment.")) return;
      showStatus("Fetching Annual Data...", "info");

      let annualIncome = 0;
      let annualExpense = 0;

      // Fetch all 3 terms for the year
      for(let t=1; t<=3; t++) {
        try {
          const rSnap = await db.collection(`receipts_${currentYear}_term_${t}`).get();
          rSnap.forEach(doc => annualIncome += (doc.data().paid || 0));
        } catch(e) {} // Ignore missing terms
      }

      // Fetch all expenses for the year
      const eSnap = await db.collection('expenses').get();
      eSnap.forEach(doc => {
        const d = doc.data();
        if(new Date(d.date).getFullYear() === currentYear) {
          annualExpense += (d.amount || 0);
        }
      });

      // Create Excel
      const wb = XLSX.utils.book_new();
      const taxData = [
        ["HERIWADI CHRISTIAN SCHOOLS LTD"],
        ["ANNUAL INCOME STATEMENT (Tax Purpose)"],
        [`Financial Year: ${currentYear}`],
        [],
        ["REVENUE"],
        ["Gross Tuition & Fee Income", annualIncome],
        ["Total Revenue", annualIncome],
        [],
        ["OPERATING EXPENSES"],
        ["Total Deductible Expenses", annualExpense],
        [],
        ["NET INCOME (Before Tax)", annualIncome - annualExpense]
      ];

      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(taxData), "Income Statement");
      XLSX.writeFile(wb, `Tax_Return_Data_${currentYear}.xlsx`);
      
      closeReportModal();
      showStatus("Tax Report Downloaded", "success");
    }

    // 3C. Simple Export (Existing)
    function exportFinancialReport() {
      // Reuse existing bank transaction data for simple export
      const ws = XLSX.utils.json_to_sheet(financialData.bankTransactions);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Transactions");
      XLSX.writeFile(wb, `Simple_Export_${currentYear}.xlsx`);
      closeReportModal();
    }

  </script>
</body>
</html>
