<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Dashboard | Heriwadi Christian Schools</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #005fa3;
      --secondary-color: #004080;
      --accent-color: #00a8e8;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; color: #333; line-height: 1.6; }

    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white; padding: 1.5rem; text-align: center; box-shadow: var(--box-shadow);
    }

    nav {
      background: var(--secondary-color); padding: 0.75rem 1.5rem;
      display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; box-shadow: var(--box-shadow);
    }

    nav a {
      color: white; text-decoration: none; padding: 0.5rem 1rem;
      border-radius: var(--border-radius); transition: var(--transition);
      display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem;
    }

    nav a:hover { background: var(--accent-color); transform: translateY(-2px); }
    nav a.active { background: var(--accent-color); font-weight: bold; }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }

    /* Admin Panel Styles */
    .admin-panel {
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
      color: white; padding: 1rem; border-radius: var(--border-radius);
      margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
    }
    
    /* Year Selector Styles */
    .year-select-container {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem;
      border-radius: var(--border-radius); color: white;
    }
    .year-select-container select {
      border: none; background: white; padding: 0.25rem 0.5rem;
      border-radius: 4px; font-weight: bold; color: #333; cursor: pointer;
    }

    .year-status-badge {
      padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: bold; font-size: 0.9rem;
      text-transform: uppercase; margin-left: 10px;
    }
    .status-open { background-color: #28a745; color: white; }
    .status-closed { background-color: #dc3545; color: white; }

    .dashboard-header {
      background: white; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); padding: 1.5rem; margin-bottom: 1.5rem;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem; border: none; border-radius: var(--border-radius);
      cursor: pointer; transition: var(--transition); display: inline-flex;
      align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 500;
    }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-warning { background: var(--warning-color); color: #333; }

    /* Stats Grid */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem; margin-bottom: 2rem;
    }
    .stat-card {
      background: white; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); padding: 1.5rem; transition: var(--transition);
    }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-title { font-size: 1rem; color: #666; margin-bottom: 0.5rem; }
    .stat-value { font-size: 1.8rem; font-weight: bold; }
    .positive { color: var(--success-color); }
    .negative { color: var(--danger-color); }

    /* Department Sections */
    .department-section {
      background: white; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); margin-bottom: 1.5rem; overflow: hidden;
    }
    .department-header {
      padding: 1rem 1.5rem; background: var(--primary-color); color: white;
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .department-content { padding: 1.5rem; display: none; }
    .department-content.active { display: block; }

    .mini-stat-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem; margin-bottom: 1.5rem;
    }
    .mini-stat {
      background: #f8f9fa; padding: 1rem; border-radius: var(--border-radius); text-align: center;
    }
    .mini-stat label { font-size: 0.85rem; color: #666; display: block; margin-bottom: 0.5rem; }
    .mini-stat span { font-size: 1.2rem; font-weight: bold; }

    .transactions-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
    .transactions-table th, .transactions-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
    .transactions-table th { background: #f8f9fa; }

    /* Modals */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white; border-radius: var(--border-radius); width: 90%; max-width: 500px;
      padding: 1.5rem; position: relative;
    }
    .report-option {
      display: block; padding: 1rem; border: 1px solid #ddd; border-radius: var(--border-radius);
      margin-bottom: 0.5rem; cursor: pointer; transition: 0.2s;
    }
    .report-option:hover { background-color: #f0f8ff; border-color: var(--primary-color); }

    .status-message { padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
    .status-message.active { display: block; }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .status-info { background: #d1ecf1; color: #0c5460; }

    @media (max-width: 768px) {
      .stats-grid, .mini-stat-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Heriwadi Christian Schools Ltd</h1>
    <p>Financial Management Dashboard</p>
  </header>

  <nav>
    <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="receipts.html"><i class="fas fa-receipt"></i> Receipts</a>
    <a href="students.html"><i class="fas fa-users"></i> Students</a>
    <a href="expense.html"><i class="fas fa-money-bill-wave"></i> Expenses</a>
    <a href="assets.html"><i class="fas fa-laptop-house"></i> Assets</a>
    <a href="staff.html"><i class="fas fa-user-tie"></i> Staff</a>
    <a href="payroll.html"><i class="fas fa-money-check-alt"></i> Payroll</a>
    <a href="financials.html" class="active"><i class="fas fa-chart-line"></i> Financial</a>
  </nav>

  <div class="container">
    
    <div class="admin-panel">
      <div style="display: flex; align-items: center; gap: 10px;">
        <h3><i class="fas fa-shield-alt"></i> Admin Control</h3>
        
        <div class="year-select-container">
            <label>Year:</label>
            <select id="yearSelector" onchange="switchYear(this.value)">
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
        </div>

        <span id="yearStatusBadge" class="year-status-badge status-open">Checking...</span>
      </div>
      <div>
        <button class="btn btn-danger" id="closeYearBtn" onclick="confirmCloseYear()">
          <i class="fas fa-lock"></i> Close Financial Year
        </button>
      </div>
    </div>

    <div class="dashboard-header">
      <h2 class="dashboard-title">Overview: Term <span id="currentTermDisplay">2</span>, <span id="displayYear">2025</span></h2>
      <div class="refresh-controls">
        <button class="btn btn-primary" onclick="loadAllFinancialData()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-success" onclick="openReportModal()">
          <i class="fas fa-file-invoice-dollar"></i> Reports Center
        </button>
      </div>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div style="margin-bottom: 20px; text-align: center;">
      <button class="btn btn-primary term-btn" data-term="1" onclick="switchTerm(1)">Term 1</button>
      <button class="btn btn-primary term-btn" data-term="2" onclick="switchTerm(2)">Term 2</button>
      <button class="btn btn-primary term-btn" data-term="3" onclick="switchTerm(3)">Term 3</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Net Bank Balance</div>
        <div class="stat-value" id="bankBalance">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Transport P&L</div>
        <div class="stat-value" id="transportPL">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Food P&L</div>
        <div class="stat-value" id="foodPL">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Uniform P&L</div>
        <div class="stat-value" id="uniformPL">KES 0</div>
      </div>
    </div>

    <div class="department-section">
      <div class="department-header" onclick="toggleSection('bank')">
        <h3><i class="fas fa-university"></i> Bank Account Management</h3>
        <i class="fas fa-chevron-down" id="bankChevron"></i>
      </div>
      <div class="department-content active" id="bankContent">
        <div class="mini-stat-grid">
          <div class="mini-stat"><label>Total Income</label><span class="positive" id="bankIncome">KES 0</span></div>
          <div class="mini-stat"><label>Total Expenses</label><span class="negative" id="bankExpenses">KES 0</span></div>
          <div class="mini-stat"><label>Net Flow</label><span id="bankNetFlow">KES 0</span></div>
        </div>
        <table class="transactions-table">
          <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Balance</th></tr></thead>
          <tbody id="bankTransactionsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="department-section">
      <div class="department-header" onclick="toggleSection('transport')">
        <h3><i class="fas fa-bus"></i> Transport Department</h3>
        <i class="fas fa-chevron-down" id="transportChevron"></i>
      </div>
      <div class="department-content" id="transportContent">
        <div class="mini-stat-grid">
          <div class="mini-stat"><label>Students</label><span id="transportStudents">0</span></div>
          <div class="mini-stat"><label>Revenue</label><span class="positive" id="transportRevenue">KES 0</span></div>
          <div class="mini-stat"><label>Expenses</label><span class="negative" id="transportExpenses">KES 0</span></div>
          <div class="mini-stat"><label>Net P&L</label><span id="transportNet">KES 0</span></div>
        </div>
        <h4>Student Payments</h4>
        <table class="transactions-table">
          <thead><tr><th>Name</th><th>Fee</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
          <tbody id="transportStudentsTable"></tbody>
        </table>
        <h4>Department Expenses</h4>
        <table class="transactions-table">
          <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead>
          <tbody id="transportExpensesTable"></tbody>
        </table>
      </div>
    </div>

    <div class="department-section">
      <div class="department-header" onclick="toggleSection('food')">
        <h3><i class="fas fa-utensils"></i> Food Department</h3>
        <i class="fas fa-chevron-down" id="foodChevron"></i>
      </div>
      <div class="department-content" id="foodContent">
        <div class="mini-stat-grid">
          <div class="mini-stat"><label>Students</label><span id="foodStudents">0</span></div>
          <div class="mini-stat"><label>Revenue</label><span class="positive" id="foodRevenue">KES 0</span></div>
          <div class="mini-stat"><label>Expenses</label><span class="negative" id="foodExpenses">KES 0</span></div>
          <div class="mini-stat"><label>Net P&L</label><span id="foodNet">KES 0</span></div>
        </div>
        <h4>Student Payments</h4>
        <table class="transactions-table">
          <thead><tr><th>Name</th><th>Fee</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
          <tbody id="foodStudentsTable"></tbody>
        </table>
        <h4>Department Expenses</h4>
        <table class="transactions-table">
          <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead>
          <tbody id="foodExpensesTable"></tbody>
        </table>
      </div>
    </div>

    <div class="department-section">
      <div class="department-header" onclick="toggleSection('uniform')">
        <h3><i class="fas fa-tshirt"></i> Uniform Department</h3>
        <i class="fas fa-chevron-down" id="uniformChevron"></i>
      </div>
      <div class="department-content" id="uniformContent">
        <div class="mini-stat-grid">
          <div class="mini-stat"><label>Students</label><span id="uniformStudents">0</span></div>
          <div class="mini-stat"><label>Revenue</label><span class="positive" id="uniformRevenue">KES 0</span></div>
          <div class="mini-stat"><label>Expenses</label><span class="negative" id="uniformExpenses">KES 0</span></div>
          <div class="mini-stat"><label>Net P&L</label><span id="uniformNet">KES 0</span></div>
        </div>
        <h4>Student Payments</h4>
        <table class="transactions-table">
          <thead><tr><th>Name</th><th>Fee</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
          <tbody id="uniformStudentsTable"></tbody>
        </table>
        <h4>Department Expenses</h4>
        <table class="transactions-table">
          <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead>
          <tbody id="uniformExpensesTable"></tbody>
        </table>
      </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px;">
      <h3 style="text-align:center; color:var(--primary-color)">Profit & Loss Overview</h3>
      <canvas id="profitLossChart" style="max-height: 400px;"></canvas>
    </div>

  </div>

  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
        <h3>Select Report Type</h3>
        <button class="btn btn-warning" onclick="closeReportModal()">X</button>
      </div>
      <div class="report-option" onclick="generateAccountantReport()">
        <i class="fas fa-calculator"></i> <strong>Accountant's Pack</strong> (Ledgers, Breakdowns)
      </div>
      <div class="report-option" onclick="generateTaxReport()">
        <i class="fas fa-landmark"></i> <strong>Tax Authority (KRA) Summary</strong> (Annual P&L)
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAA6zY40EwbTmWUx1op1cx52C3y0RK3m0",
      authDomain: "heriwadi-manager.firebaseapp.com",
      projectId: "heriwadi-manager",
      storageBucket: "heriwadi-manager.appspot.com",
      messagingSenderId: "654632910809",
      appId: "1:654632910809:web:7c65613d2510402a6663c8",
      measurementId: "G-LLHS6GLB6E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // UPDATED: Use h_term and h_year to match other pages
    let currentTerm = parseInt(sessionStorage.getItem('h_term')) || 2;
    let currentYear = parseInt(sessionStorage.getItem('h_year')) || new Date().getFullYear();
    let isYearClosed = false;
    
    // Complete Data Storage
    let financialData = {
      students: [],
      receipts: [],
      expenses: [],
      bankTransactions: []
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Set dropdown and displays on load
      const ySelect = document.getElementById('yearSelector');
      if(ySelect) ySelect.value = currentYear;
      
      document.getElementById('displayYear').textContent = currentYear;
      document.getElementById('currentTermDisplay').textContent = currentTerm;
      
      checkYearStatus();
      loadAllFinancialData();
    });

    function showStatus(msg, type='info') {
      const el = document.getElementById('statusMessage');
      el.textContent = msg;
      el.className = `status-message status-${type} active`;
      setTimeout(() => el.classList.remove('active'), 4000);
    }

    function switchTerm(term) {
      currentTerm = term;
      sessionStorage.setItem('h_term', term); // Save selection
      document.getElementById('currentTermDisplay').textContent = term;
      loadAllFinancialData();
    }

    function switchYear(year) {
      currentYear = parseInt(year);
      sessionStorage.setItem('h_year', year); // Save selection
      
      document.getElementById('displayYear').textContent = currentYear;
      showStatus(`Switched to Financial Year: ${currentYear}`, 'info');
      
      checkYearStatus(); // Check if new year is locked
      loadAllFinancialData();
    }

    function toggleSection(id) {
      document.getElementById(id+'Content').classList.toggle('active');
    }

    // --- 1. Admin Year Lock ---
    async function checkYearStatus() {
      try {
        const doc = await db.collection('system_settings').doc('financial_years').get();
        if (doc.exists) {
          // Check specifically for the currently selected year
          isYearClosed = (doc.data()[currentYear] === 'closed');
          updateAdminPanelUI();
        } else {
            isYearClosed = false;
            updateAdminPanelUI();
        }
      } catch (e) { console.error(e); }
    }

    function updateAdminPanelUI() {
      const badge = document.getElementById('yearStatusBadge');
      const btn = document.getElementById('closeYearBtn');
      if (isYearClosed) {
        badge.textContent = `${currentYear} CLOSED`;
        badge.className = "year-status-badge status-closed";
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-lock"></i> Year Locked';
      } else {
        badge.textContent = `${currentYear} OPEN`;
        badge.className = "year-status-badge status-open";
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Close Financial Year';
      }
    }

    async function confirmCloseYear() {
      if(!confirm(`WARNING: Close Financial Year ${currentYear}? This cannot be undone.`)) return;
      const password = prompt("Enter admin password:");
      if(password !== "admin2025") { alert("Incorrect password"); return; }
      
      await db.collection('system_settings').doc('financial_years').set({ [currentYear]: 'closed' }, { merge: true });
      isYearClosed = true;
      updateAdminPanelUI();
      alert(`Financial Year ${currentYear} Closed Successfully.`);
    }

    // --- 2. Data Loading (Updated to include Students for Departments) ---
    async function loadAllFinancialData() {
      showStatus(`Loading data for Term ${currentTerm}, ${currentYear}...`, "info");
      financialData = { students: [], receipts: [], expenses: [], bankTransactions: [] };

      try {
        // 1. Load Students (Needed for fee allocation calculation)
        const sSnap = await db.collection(`students_${currentYear}_term_${currentTerm}`).get();
        sSnap.forEach(doc => financialData.students.push({ id: doc.id, ...doc.data() }));

        // 2. Load Receipts
        const rSnap = await db.collection(`receipts_${currentYear}_term_${currentTerm}`).get();
        rSnap.forEach(doc => financialData.receipts.push({ id: doc.id, ...doc.data() }));

        // 3. Load Expenses (Filter by selected year in memory)
        const eSnap = await db.collection('expenses').get();
        eSnap.forEach(doc => {
          const d = doc.data();
          const expenseDate = new Date(d.date);
          if(getTermFromDate(d.date) === currentTerm && expenseDate.getFullYear() === currentYear) {
            financialData.expenses.push(d);
          }
        });

        processFinancials(); // Updates Bank & Charts
        updateDepartmentSections(); // Updates Transport/Food/Uniform
        showStatus("Dashboard Updated", "success");

      } catch (e) {
        console.error(e);
        showStatus("Error: " + e.message, "error");
      }
    }

    function getTermFromDate(dateString) {
      const month = new Date(dateString).getMonth() + 1;
      if (month <= 4) return 1;
      if (month <= 8) return 2;
      return 3;
    }

    // --- 3. General Processing (Bank & Overview) ---
    function processFinancials() {
      let income = 0;
      let expense = 0;
      const transactions = [];

      financialData.receipts.forEach(r => {
        income += (r.paid || 0);
        transactions.push({ date: r.date, desc: `Fee: ${r.name}`, type: 'Credit', amount: r.paid || 0 });
      });

      financialData.expenses.forEach(e => {
        expense += (e.amount || 0);
        transactions.push({ date: e.date, desc: `Exp: ${e.description}`, type: 'Debit', amount: e.amount || 0 });
      });

      transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
      let bal = 0;
      transactions.forEach(t => {
        if(t.type === 'Credit') bal += t.amount; else bal -= t.amount;
        t.balance = bal;
      });

      financialData.bankTransactions = transactions;

      // Update Bank UI
      document.getElementById('bankBalance').textContent = `KES ${bal.toLocaleString()}`;
      document.getElementById('bankIncome').textContent = `KES ${income.toLocaleString()}`;
      document.getElementById('bankExpenses').textContent = `KES ${expense.toLocaleString()}`;
      document.getElementById('bankNetFlow').textContent = `KES ${(income - expense).toLocaleString()}`;

      // Render Bank Table (Last 20)
      const tbody = document.getElementById('bankTransactionsTable');
      tbody.innerHTML = '';
      transactions.slice().reverse().slice(0, 20).forEach(t => {
        tbody.innerHTML += `<tr>
          <td>${new Date(t.date).toLocaleDateString()}</td>
          <td>${t.desc}</td>
          <td style="color:${t.type==='Credit'?'green':'red'}">${t.type}</td>
          <td>${t.amount.toLocaleString()}</td>
          <td>${t.balance.toLocaleString()}</td>
        </tr>`;
      });

      renderChart(income, expense);
    }

    // --- 4. Department Logic (Restored) ---
    function updateDepartmentSections() {
      updateDepartment('transport', ['Motor vehicle expenses', 'Fuel & Gas', 'Transport']);
      updateDepartment('lunch', ['Food']); // 'lunch' matches student field
      updateDepartment('uniform', ['Uniform Purchase', 'Staff Uniforms']);
    }

    function updateDepartment(feeType, expenseCategories) {
      let revenue = 0;
      const studentList = [];
      const expenseList = [];
      let totalExpenses = 0;

      // 1. Calculate Revenue from Student Payments
      financialData.students.forEach(student => {
        if (student[feeType] && student[feeType] > 0) {
          // Find total paid by this student
          const studentReceipts = financialData.receipts.filter(r => r.name === student.name);
          const totalPaid = studentReceipts.reduce((sum, r) => sum + (r.paid || 0), 0);

          // Calculate Proportional Share
          const totalFees = (student.tuition||0) + (student.adm||0) + (student.books||0) + 
                            (student.stationery||0) + (student.uniform||0) + (student.lunch||0) + 
                            (student.transport||0) + (student.trip||0) + (student.graduation||0);
          
          let allocatedPaid = 0;
          if (totalFees > 0) {
            allocatedPaid = totalPaid * (student[feeType] / totalFees);
          }
          revenue += allocatedPaid;

          studentList.push({
            name: student.name,
            fee: student[feeType],
            paid: allocatedPaid,
            bal: student[feeType] - allocatedPaid
          });
        }
      });

      // 2. Calculate Expenses
      financialData.expenses.forEach(e => {
        if(expenseCategories.includes(e.category)) {
          totalExpenses += (e.amount || 0);
          expenseList.push(e);
        }
      });

      const profit = revenue - totalExpenses;
      const prefix = feeType === 'lunch' ? 'food' : feeType; // UI ID mapping

      // Update UI Stats
      document.getElementById(`${prefix}Students`).textContent = studentList.length;
      document.getElementById(`${prefix}Revenue`).textContent = `KES ${revenue.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
      document.getElementById(`${prefix}Expenses`).textContent = `KES ${totalExpenses.toLocaleString()}`;
      const plEl = document.getElementById(`${prefix}Net`);
      const plStat = document.getElementById(`${prefix}PL`);
      
      plEl.textContent = `KES ${profit.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
      plEl.className = profit >= 0 ? "positive" : "negative";
      
      // Update Top Grid Stat
      if(plStat) {
        plStat.textContent = `KES ${profit.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        plStat.className = profit >= 0 ? "stat-value positive" : "stat-value negative";
      }

      // Update Student Table
      const sTable = document.getElementById(`${prefix}StudentsTable`);
      sTable.innerHTML = '';
      studentList.forEach(s => {
        sTable.innerHTML += `<tr>
          <td>${s.name}</td>
          <td>${s.fee.toLocaleString()}</td>
          <td>${s.paid.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
          <td style="color:${s.bal>0?'red':'green'}">${s.bal.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
          <td>${s.bal <= 0 ? 'Paid' : 'Due'}</td>
        </tr>`;
      });

      // Update Expense Table
      const eTable = document.getElementById(`${prefix}ExpensesTable`);
      eTable.innerHTML = '';
      expenseList.forEach(e => {
        eTable.innerHTML += `<tr>
          <td>${new Date(e.date).toLocaleDateString()}</td>
          <td>${e.description}</td>
          <td>${e.category}</td>
          <td>${e.amount.toLocaleString()}</td>
        </tr>`;
      });
    }

    function renderChart(inc, exp) {
      const ctx = document.getElementById('profitLossChart').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses', 'Net Profit'],
          datasets: [{
            label: `Term ${currentTerm} (${currentYear})`,
            data: [inc, exp, inc-exp],
            backgroundColor: ['#28a745', '#dc3545', '#005fa3']
          }]
        }
      });
    }

    // --- 5. Report Logic ---
    function openReportModal() { document.getElementById('reportModal').classList.add('show'); }
    function closeReportModal() { document.getElementById('reportModal').classList.remove('show'); }

    async function generateAccountantReport() {
      const wb = XLSX.utils.book_new();
      const sData = [
        ["Accountant Report", `Year: ${currentYear} | Term: ${currentTerm}`],
        [], ["Category", "Amount"],
        ["Bank Income", document.getElementById('bankIncome').textContent],
        ["Bank Expense", document.getElementById('bankExpenses').textContent],
        ["Net", document.getElementById('bankNetFlow').textContent]
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sData), "Summary");
      
      // Ledger
      const lData = financialData.bankTransactions.map(t => ({
        Date: new Date(t.date).toLocaleDateString(),
        Desc: t.desc, Type: t.type, Debit: t.type==='Debit'?t.amount:0, Credit: t.type==='Credit'?t.amount:0, Bal: t.balance
      }));
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(lData), "Ledger");

      XLSX.writeFile(wb, `Accountant_Report_${currentYear}_T${currentTerm}.xlsx`);
      closeReportModal();
    }

    async function generateTaxReport() {
      if(!confirm(`Fetch Annual Data for Tax Report for ${currentYear}?`)) return;
      let annInc = 0, annExp = 0;
      
      // Fetch All Terms (1-3)
      for(let t=1; t<=3; t++) {
        try {
          const rSnap = await db.collection(`receipts_${currentYear}_term_${t}`).get();
          rSnap.forEach(d => annInc += (d.data().paid || 0));
        } catch(e){}
      }
      
      const eSnap = await db.collection('expenses').get();
      eSnap.forEach(d => {
        if(new Date(d.data().date).getFullYear() === currentYear) annExp += (d.data().amount || 0);
      });

      const wb = XLSX.utils.book_new();
      const data = [
        ["HERIWADI SCHOOLS - ANNUAL TAX SUMMARY"],
        [`Year: ${currentYear}`], [],
        ["REVENUE", annInc], ["EXPENSES", annExp], ["NET INCOME", annInc - annExp]
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "Income Statement");
      XLSX.writeFile(wb, `Tax_Report_${currentYear}.xlsx`);
      closeReportModal();
    }
  </script>
</body>
</html>
