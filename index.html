<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Heriwadi Christian Schools Ltd</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #0077cc;
            --secondary-color: #005fa3;
            --accent-color: #00a8e8;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
            --white: #ffffff;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, #e3f2fd 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Modern Navigation */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-medium);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0;
            height: 80px;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            height: 100%;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        .nav-logo {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 0.85rem;
            min-width: 70px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: white;
            border-radius: 2px;
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Welcome Section */
        .welcome-section {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 3rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .welcome-section::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite reverse;
        }

        .welcome-content {
            position: relative;
            z-index: 1;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            animation: slideInUp 0.8s ease-out;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            animation: slideInUp 0.8s ease-out 0.2s both;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            animation: slideInUp 0.8s ease-out 0.4s both;
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            animation: fadeInUp 0.6s ease-out;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .stat-change.neutral {
            color: var(--dark-gray);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
        }

        .card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            justify-content: between;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        /* Recent Activities */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            background: var(--light-gray);
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--medium-gray);
            transform: translateX(5px);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            background: var(--primary-color);
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--dark-gray);
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
        }

        /* Term Selector */
        .term-selector {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .term-info h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .term-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .term-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .term-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .term-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--medium-gray);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        .status-message.success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .status-message.info {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border-left: 4px solid var(--info-color);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .nav-container {
                padding: 0 1rem;
            }

            .nav-menu {
                gap: 0;
            }

            .nav-link {
                min-width: 60px;
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .welcome-subtitle {
                font-size: 1rem;
            }

            .quick-actions {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .term-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Performance optimizations */
        .stat-card,
        .dashboard-card,
        .activity-item {
            will-change: transform;
        }

        /* Dark mode support preparation */
        @media (prefers-color-scheme: dark) {
            :root {
                --light-gray: #1a1a1a;
                --medium-gray: #2d2d2d;
                --dark-gray: #ffffff;
                --white: #242424;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="nav-brand">
                <div class="nav-logo">
                    <i class="fas fa-school"></i>
                </div>
                Heriwadi Christian Schools Ltd
            </a>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link active">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="receipts.html" class="nav-link">
                        <i class="fas fa-receipt nav-icon"></i>
                        <span>Receipts</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="expense.html" class="nav-link">
                        <i class="fas fa-money-bill-wave nav-icon"></i>
                        <span>Expenses</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="assets.html" class="nav-link">
                        <i class="fas fa-laptop-house nav-icon"></i>
                        <span>Assets</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="staff.html" class="nav-link">
                        <i class="fas fa-chalkboard-teacher nav-icon"></i>
                        <span>Staff</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="students.html" class="nav-link">
                        <i class="fas fa-user-graduate nav-icon"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="payroll.html" class="nav-link">
                        <i class="fas fa-money-check-alt nav-icon"></i>
                        <span>Payroll</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="financials.html" class="nav-link">
                        <i class="fas fa-chart-line nav-icon"></i>
                        <span>Financials</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Status Messages -->
        <div id="statusContainer"></div>

        <!-- Welcome Section -->
        <section class="welcome-section">
            <div class="welcome-content">
                <h1 class="welcome-title">Welcome Back, Administrator!</h1>
                <p class="welcome-subtitle">Here's your school management overview for today</p>
                <div class="quick-actions">
                    <a href="receipts.html" class="quick-action-btn">
                        <i class="fas fa-plus"></i>
                        New Receipt
                    </a>
                    <a href="students.html" class="quick-action-btn">
                        <i class="fas fa-user-plus"></i>
                        Add Student
                    </a>
                    <a href="expense.html" class="quick-action-btn">
                        <i class="fas fa-receipt"></i>
                        Log Expense
                    </a>
                    <a href="financials.html" class="quick-action-btn">
                        <i class="fas fa-chart-bar"></i>
                        View Reports
                    </a>
                </div>
            </div>
        </section>

        <!-- Term Selector -->
        <section class="term-selector">
            <div class="term-info">
                <h3><i class="fas fa-calendar-alt"></i> Academic Term Management</h3>
                <p>Current Academic Year: <strong id="currentYear">2024</strong> | Active Term: <strong id="activeTerm">Term 2</strong></p>
            </div>
            <div class="term-buttons">
                <button class="term-btn" data-term="1" onclick="switchTerm(1)">Term 1</button>
                <button class="term-btn active" data-term="2" onclick="switchTerm(2)">Term 2</button>
                <button class="term-btn" data-term="3" onclick="switchTerm(3)">Term 3</button>
            </div>
        </section>

        <!-- Stats Grid -->
        <section class="stats-grid">
            <div class="stat-card" style="animation-delay: 0.1s">
                <div class="stat-header">
                    <span class="stat-title">Total Students</span>
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-change neutral" id="studentsChange">
                    <i class="fas fa-users"></i>
                    <span>Across all classes</span>
                </div>
            </div>

            <div class="stat-card" style="animation-delay: 0.2s">
                <div class="stat-header">
                    <span class="stat-title">Active Staff</span>
                    <div class="stat-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalStaff">0</div>
                <div class="stat-change neutral" id="staffChange">
                    <i class="fas fa-user-tie"></i>
                    <span>Total staff members</span>
                </div>
            </div>

            <div class="stat-card" style="animation-delay: 0.3s">
                <div class="stat-header">
                    <span class="stat-title">Monthly Revenue</span>
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-value" id="monthlyRevenue">KES 0</div>
                <div class="stat-change positive" id="revenueChange">
                    <i class="fas fa-arrow-up"></i>
                    <span>This month</span>
                </div>
            </div>

            <div class="stat-card" style="animation-delay: 0.4s">
                <div class="stat-header">
                    <span class="stat-title">Outstanding Balance</span>
                    <div class="stat-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                </div>
                <div class="stat-value" id="outstandingBalance">KES 0</div>
                <div class="stat-change negative" id="balanceChange">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Total pending</span>
                </div>
            </div>

            <div class="stat-card" style="animation-delay: 0.5s">
                <div class="stat-header">
                    <span class="stat-title">Total Assets</span>
                    <div class="stat-icon">
                        <i class="fas fa-laptop-house"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalAssets">KES 0</div>
                <div class="stat-change neutral" id="assetsChange">
                    <i class="fas fa-building"></i>
                    <span>Asset value</span>
                </div>
            </div>

            <div class="stat-card" style="animation-delay: 0.6s">
                <div class="stat-header">
                    <span class="stat-title">Monthly Expenses</span>
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="stat-value" id="monthlyExpenses">KES 0</div>
                <div class="stat-change negative" id="expensesChange">
                    <i class="fas fa-arrow-down"></i>
                    <span>This month</span>
                </div>
            </div>
        </section>

        <!-- Dashboard Grid -->
        <section class="dashboard-grid">
            <!-- Financial Overview Chart -->
            <div class="dashboard-card" style="animation-delay: 0.7s">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        Financial Overview
                    </h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="dashboard-card" style="animation-delay: 0.8s">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-clock"></i>
                        Recent Activities
                    </h2>
                </div>
                <div class="card-body">
                    <div class="activity-list" id="activityList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Class Distribution Chart -->
        <section class="dashboard-card" style="animation-delay: 0.9s; margin-bottom: 2rem;">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-users"></i>
                    Student Distribution by Class
                </h2>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="classDistributionChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAA6zY40EwbTmWUx1op1cx52C3y0RK3m0",
            authDomain: "heriwadi-manager.firebaseapp.com",
            projectId: "heriwadi-manager",
            storageBucket: "heriwadi-manager.firebasestorage.app",
            messagingSenderId: "654632910809",
            appId: "1:654632910809:web:7c65613d2510402a6663c8",
            measurementId: "G-LLHS6GLB6E"
        };

        // Initialize Firebase
        let app, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showStatus("Failed to initialize Firebase. Check your configuration.", "error");
        }

        // Current term management with persistence
        let currentTerm = parseInt(sessionStorage.getItem('heriwadi_current_term')) || 2;
        let currentYear = new Date().getFullYear();

        // Collection references
        const getCollection = (name, term = null, year = currentYear) => {
            if (term !== null) {
                return db.collection(`${name}_${year}_term_${term}`);
            }
            return db.collection(name);
        };

        // Global data cache
        let dashboardData = {
            students: [],
            staff: [],
            receipts: [],
            expenses: [],
            assets: [],
            lastUpdated: null
        };

        // Charts instances
        let financialChart = null;
        let classChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
            loadAllDashboardData();
            setupAutoRefresh();
            
            // Update current year display
            document.getElementById('currentYear').textContent = currentYear;
            document.getElementById('activeTerm').textContent = `Term ${currentTerm}`;
            updateTermButtons();
        });

        // Initialize UI elements
        function initializeUI() {
            updateTermButtons();
            showStatus("Dashboard loading...", "info");
        }

        // Update term button states
        function updateTermButtons() {
            document.querySelectorAll('.term-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.term) === currentTerm);
            });
        }

        // Switch term with persistence
        function switchTerm(term) {
            currentTerm = term;
            sessionStorage.setItem('heriwadi_current_term', term.toString());
            
            updateTermButtons();
            document.getElementById('activeTerm').textContent = `Term ${term}`;
            
            showStatus(`Switched to Term ${term} - Loading data...`, "info");
            loadAllDashboardData();
        }

        // Load all dashboard data
        async function loadAllDashboardData() {
            try {
                showStatus("Loading dashboard data...", "info");
                
                // Load data concurrently
                const [students, staff, receipts, expenses, assets] = await Promise.all([
                    loadStudentsData(),
                    loadStaffData(),
                    loadReceiptsData(),
                    loadExpensesData(),
                    loadAssetsData()
                ]);

                // Update cache
                dashboardData = {
                    students,
                    staff,
                    receipts,
                    expenses,
                    assets,
                    lastUpdated: new Date()
                };

                // Update UI
                updateDashboardStats();
                updateFinancialChart();
                updateClassDistributionChart();
                updateRecentActivities();

                showStatus("Dashboard data loaded successfully!", "success");
                setTimeout(() => clearStatus(), 3000);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showStatus("Error loading dashboard data. Please check your connection.", "error");
            }
        }

        // Load students data
        async function loadStudentsData() {
            try {
                const studentsCollection = getCollection('students', currentTerm);
                const snapshot = await studentsCollection.get();
                const students = [];
                
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                
                return students;
            } catch (error) {
                console.error('Error loading students:', error);
                return [];
            }
        }

        // Load staff data
        async function loadStaffData() {
            try {
                const staffCollection = getCollection('staff');
                const snapshot = await staffCollection.get();
                const staff = [];
                
                snapshot.forEach(doc => {
                    staff.push({ id: doc.id, ...doc.data() });
                });
                
                return staff;
            } catch (error) {
                console.error('Error loading staff:', error);
                return [];
            }
        }

        // Load receipts data
        async function loadReceiptsData() {
            try {
                const receiptsCollection = getCollection('receipts', currentTerm);
                const snapshot = await receiptsCollection.orderBy('date', 'desc').limit(50).get();
                const receipts = [];
                
                snapshot.forEach(doc => {
                    receipts.push({ id: doc.id, ...doc.data() });
                });
                
                return receipts;
            } catch (error) {
                console.error('Error loading receipts:', error);
                return [];
            }
        }

        // Load expenses data
        async function loadExpensesData() {
            try {
                const expensesCollection = getCollection('expenses');
                const snapshot = await expensesCollection.orderBy('date', 'desc').limit(50).get();
                const expenses = [];
                
                snapshot.forEach(doc => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                
                return expenses;
            } catch (error) {
                console.error('Error loading expenses:', error);
                return [];
            }
        }

        // Load assets data
        async function loadAssetsData() {
            try {
                const assetsCollection = getCollection('assets');
                const snapshot = await assetsCollection.get();
                const assets = [];
                
                snapshot.forEach(doc => {
                    assets.push({ id: doc.id, ...doc.data() });
                });
                
                return assets;
            } catch (error) {
                console.error('Error loading assets:', error);
                return [];
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const { students, staff, receipts, expenses, assets } = dashboardData;

            // Total Students
            const totalStudents = students.length;
            updateStatCard('totalStudents', totalStudents);

            // Total Staff
            const totalStaff = staff.length;
            updateStatCard('totalStaff', totalStaff);

            // Calculate monthly revenue
            const currentMonth = new Date().toISOString().substr(0, 7);
            const monthlyRevenue = receipts
                .filter(r => r.date && r.date.startsWith(currentMonth))
                .reduce((sum, r) => sum + (r.paid || 0), 0);
            updateStatCard('monthlyRevenue', `KES ${monthlyRevenue.toLocaleString('en-KE')}`);

            // Calculate outstanding balance
            const totalOutstanding = students.reduce((sum, s) => {
                const balance = calculateStudentBalance(s);
                return sum + Math.max(0, balance);
            }, 0);
            updateStatCard('outstandingBalance', `KES ${totalOutstanding.toLocaleString('en-KE')}`);

            // Calculate total assets value
            const totalAssetsValue = assets.reduce((sum, a) => sum + (a.amount || 0), 0);
            updateStatCard('totalAssets', `KES ${totalAssetsValue.toLocaleString('en-KE')}`);

            // Calculate monthly expenses
            const monthlyExpenses = expenses
                .filter(e => e.date && e.date.startsWith(currentMonth))
                .reduce((sum, e) => sum + (e.amount || 0), 0);
            updateStatCard('monthlyExpenses', `KES ${monthlyExpenses.toLocaleString('en-KE')}`);
        }

        // Calculate student balance
        function calculateStudentBalance(student) {
            const totalFees = (student.tuition || 0) + (student.adm || 0) + 
                             (student.books || 0) + (student.stationery || 0) + 
                             (student.uniform || 0) + (student.lunch || 0) + 
                             (student.transport || 0) + (student.trip || 0) + 
                             (student.graduation || 0);
            
            const currentTermBalance = totalFees - (student.paid || 0);
            const carriedForward = student.carriedForwardBalance || 0;
            
            return currentTermBalance + carriedForward;
        }

        // Update individual stat card
        function updateStatCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.classList.add('pulse-update');
                setTimeout(() => element.classList.remove('pulse-update'), 600);
            }
        }

        // Update financial chart
        function updateFinancialChart() {
            const ctx = document.getElementById('financialChart');
            if (!ctx) return;

            // Destroy existing chart
            if (financialChart) {
                financialChart.destroy();
            }

            // Prepare data for last 6 months
            const months = [];
            const revenueData = [];
            const expenseData = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthStr = date.toISOString().substr(0, 7);
                
                months.push(date.toLocaleDateString('en-US', { month: 'short' }));
                
                // Calculate revenue for this month
                const monthRevenue = dashboardData.receipts
                    .filter(r => r.date && r.date.startsWith(monthStr))
                    .reduce((sum, r) => sum + (r.paid || 0), 0);
                revenueData.push(monthRevenue);

                // Calculate expenses for this month
                const monthExpenses = dashboardData.expenses
                    .filter(e => e.date && e.date.startsWith(monthStr))
                    .reduce((sum, e) => sum + (e.amount || 0), 0);
                expenseData.push(monthExpenses);
            }

            financialChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': KES ' + 
                                           context.parsed.y.toLocaleString('en-KE');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Amount (KES)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + value.toLocaleString('en-KE');
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Update class distribution chart
        function updateClassDistributionChart() {
            const ctx = document.getElementById('classDistributionChart');
            if (!ctx) return;

            // Destroy existing chart
            if (classChart) {
                classChart.destroy();
            }

            // Group students by class
            const classData = {};
            const classes = ['Play Group', 'PP1', 'PP2', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6'];
            
            classes.forEach(cls => {
                classData[cls] = dashboardData.students.filter(s => s.class === cls).length;
            });

            const labels = Object.keys(classData).filter(cls => classData[cls] > 0);
            const data = labels.map(cls => classData[cls]);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0'
            ];

            classChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' students (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update recent activities
        function updateRecentActivities() {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;

            // Combine recent receipts and expenses
            const activities = [];

            // Add recent receipts
            dashboardData.receipts.slice(0, 5).forEach(receipt => {
                activities.push({
                    type: 'receipt',
                    title: `Fee payment received from ${receipt.name}`,
                    time: formatTimeAgo(receipt.date),
                    icon: 'fa-receipt',
                    color: '#28a745'
                });
            });

            // Add recent expenses
            dashboardData.expenses.slice(0, 3).forEach(expense => {
                activities.push({
                    type: 'expense',
                    title: `Expense logged: ${expense.description}`,
                    time: formatTimeAgo(expense.date),
                    icon: 'fa-money-bill-wave',
                    color: '#dc3545'
                });
            });

            // Sort by time and take latest 8
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            const recentActivities = activities.slice(0, 8);

            if (recentActivities.length === 0) {
                activityList.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon" style="background: #6c757d;">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">No recent activities</div>
                            <div class="activity-time">Start by adding students or recording transactions</div>
                        </div>
                    </div>
                `;
                return;
            }

            const activitiesHTML = recentActivities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon" style="background: ${activity.color};">
                        <i class="fas ${activity.icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                </div>
            `).join('');

            activityList.innerHTML = activitiesHTML;
        }

        // Format time ago
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Unknown time';
            
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            
            return date.toLocaleDateString('en-GB');
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            if (!container) return;

            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;
            statusDiv.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                type === 'error' ? 'fa-exclamation-circle' : 
                                'fa-info-circle'}"></i>
                ${message}
            `;

            container.appendChild(statusDiv);
            
            // Auto remove after delay
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Clear status messages
        function clearStatus() {
            const container = document.getElementById('statusContainer');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Setup auto refresh
        function setupAutoRefresh() {
            // Refresh data every 5 minutes
            setInterval(() => {
                if (!document.hidden) {
                    loadAllDashboardData();
                }
            }, 5 * 60 * 1000);

            // Refresh when tab becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && dashboardData.lastUpdated) {
                    const timeSinceUpdate = Date.now() - dashboardData.lastUpdated.getTime();
                    if (timeSinceUpdate > 2 * 60 * 1000) { // 2 minutes
                        loadAllDashboardData();
                    }
                }
            });
        }

        // Add smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add pulse animation class
        const style = document.createElement('style');
        style.textContent = `
            .pulse-update {
                animation: pulseUpdate 0.6s ease-out;
            }
            
            @keyframes pulseUpdate {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Performance monitoring
        function measurePerformance(name, fn) {
            const start = performance.now();
            const result = fn();
            const end = performance.now();
            console.log(`${name} took ${(end - start).toFixed(2)} milliseconds`);
            return result;
        }

        // Error boundary for critical functions
        function safeExecute(fn, errorMessage) {
            try {
                return fn();
            } catch (error) {
                console.error(errorMessage, error);
                showStatus(`${errorMessage}: ${error.message}`, "error");
                return null;
            }
        }

        // Debug helper (remove in production)
        window.dashboardDebug = {
            data: () => dashboardData,
            refresh: () => loadAllDashboardData(),
            switchTerm: (term) => switchTerm(term),
            clearCache: () => { dashboardData = {}; }
        };

        console.log('Modern Heriwadi Dashboard Loaded');
        console.log('Available debug commands: dashboardDebug.data(), dashboardDebug.refresh()');
    </script>
</body>
</html>
