<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payroll Module</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    header { background-color: #0074D9; color: white; padding: 1em 0; text-align: center; }
    nav { background: #005fa3; display: flex; justify-content: center; padding: 0.5em 0; flex-wrap: wrap; }
    nav a { color: white; text-decoration: none; margin: 5px 15px; font-weight: bold; }
    .container { padding: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #0074D9; color: white; }
    input[type="number"] {
      width: 80px;
      padding: 5px;
      border: 1px solid #ccc;
      text-align: right;
    }
    button { padding: 5px 10px; cursor: pointer; margin: 5px 0; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .loading { color: blue; font-style: italic; }
  </style>
</head>
<body>
  <header><h1>HCS Payroll Module</h1></header>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="students.html">Students</a>
    <a href="receipts.html">Receipts</a>
    <a href="expense.html">Expenses</a>
    <a href="assets.html">Assets</a>
    <a href="staff.html">Staff</a>
    <a href="payroll.html" style="text-decoration: underline;">Payroll</a>
  </nav>

  <div class="container">
    <button onclick="downloadPayrollPDF()">Download Consolidated PDF</button>
    <button onclick="generateBankLetterPDF()">Generate Bank Letter PDF</button>
    <table id="payrollTable">
      <thead>
        <tr>
          <th>Name</th><th>Gross Pay</th><th>PAYE</th><th>NSSF</th><th>SHIF</th><th>AHL</th><th>Advance</th>
          <th>Total Deductions</th><th>Net Pay</th><th>NSSF - Employers</th><th>AHL - Employers</th><th>NITA</th><th>Payslip</th>
        </tr>
      </thead>
      <tbody id="payrollBody"></tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBAA6zY40EwbTmWUx1op1cx52C3y0RK3m0",
      authDomain: "heriwadi-manager.firebaseapp.com",
      projectId: "heriwadi-manager",
      storageBucket: "heriwadi-manager.firebasestorage.app",
      messagingSenderId: "654632910809",
      appId: "1:654632910809:web:7c65613d2510402a6663c8",
      measurementId: "G-LLHS6GLB6E"
    };

    let app, db;
    try {
      // Check if Firebase is already initialized to avoid duplicate initialization
      if (!firebase.apps.length) {
        app = firebase.initializeApp(firebaseConfig);
      } else {
        app = firebase.app();
      }
      db = firebase.firestore();
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error('Firebase initialization error:', error);
      showStatus("Failed to initialize Firebase. Check your configuration or network connection.", "error");
      throw error;
    }
    const staffCollection = db.collection('staff');
    const payrollCollection = db.collection('payroll');

    function showStatus(message, type = 'info') {
      const statusDiv = document.createElement('div');
      statusDiv.className = type;
      statusDiv.textContent = message;
      document.querySelector('.container').insertBefore(statusDiv, document.querySelector('.container').firstChild);
      setTimeout(() => statusDiv.remove(), 5000);
    }

    function recalculateRow(row) {
      const gross = parseFloat(row.querySelector(".gross").value) || 0;
      const paye = parseFloat(row.querySelector(".paye").value) || 0;
      const nssf = parseFloat(row.querySelector(".nssf").value) || 0;
      const shif = parseFloat(row.querySelector(".shif").value) || 0;
      const ahl = parseFloat(row.querySelector(".ahl").value) || 0;
      const advance = parseFloat(row.querySelector(".advance").value) || 0;

      const total = paye + nssf + shif + ahl + advance;
      const net = gross - total;
      const nssfEmp = gross * 0.06;
      const ahlEmp = gross * 0.03;
      const nita = gross * 0.01;

      row.querySelector(".total").textContent = total.toFixed(2);
      row.querySelector(".net").textContent = net.toFixed(2);
      row.querySelector(".nssfEmp").textContent = nssfEmp.toFixed(2);
      row.querySelector(".ahlEmp").textContent = ahlEmp.toFixed(2);
      row.querySelector(".nita").textContent = nita.toFixed(2);
    }

    async function loadPayroll() {
      const tbody = document.getElementById("payrollBody");
      tbody.innerHTML = "";
      showStatus("Loading payroll data...", "loading");

      try {
        const snapshot = await staffCollection.get();
        console.log(`Retrieved ${snapshot.size} staff records`);

        if (snapshot.empty) {
          console.warn("No staff records found in Firestore");
          showStatus("No staff records found. Please add staff members in the Staff module.", "error");
          return;
        }

        snapshot.forEach(doc => {
          const staff = { id: doc.id, ...doc.data() };
          console.log(`Processing staff: ${staff.fullName || 'Unknown'}`, staff);

          // Ensure required fields have default values if missing
          const gross = parseFloat(staff.salary) || 0;
          const advance = parseFloat(staff.advance) || 0;
          const fullName = staff.fullName || `Staff_${doc.id}`; // FFallback name if fullName is missing

          const paye = gross * 0.1;
          const nssf = gross * 0.06;
          const shif = gross * 0.025;
          const ahl = gross * 0.03;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${fullName}</td>
            <td><input class="gross" type="number" value="${gross.toFixed(2)}" /></td>
            <td><input class="paye" type="number" value="${paye.toFixed(2)}" /></td>
            <td><input class="nssf" type="number" value="${nssf.toFixed(2)}" /></td>
            <td><input class="shif" type="number" value="${shif.toFixed(2)}" /></td>
            <td><input class="ahl" type="number" value="${ahl.toFixed(2)}" /></td>
            <td><input class="advance" type="number" value="${advance.toFixed(2)}" /></td>
            <td class="total"></td>
            <td class="net"></td>
            <td class="nssfEmp"></td>
            <td class="ahlEmp"></td>
            <td class="nita"></td>
            <td><button class="payslipBtn">Print</button></td>
          `;

          tbody.appendChild(row);
          recalculateRow(row);

          row.querySelectorAll("input").forEach(input => {
            input.addEventListener("input", () => recalculateRow(row));
          });

          row.querySelector(".payslipBtn").addEventListener("click", () => {
            const name = fullName;
            const gross = parseFloat(row.querySelector(".gross").value) || 0;
            const paye = parseFloat(row.querySelector(".paye").value) || 0;
            const nssf = parseFloat(row.querySelector(".nssf").value) || 0;
            const shif = parseFloat(row.querySelector(".shif").value) || 0;
            const ahl = parseFloat(row.querySelector(".ahl").value) || 0;
            const advance = parseFloat(row.querySelector(".advance").value) || 0;
            const total = paye + nssf + shif + ahl + advance;
            const net = gross - total;
            const nssfEmp = gross * 0.06;
            const ahlEmp = gross * 0.03;
            const nita = gross * 0.01;

            const win = window.open("", "Payslip", "width=800,height=600");
            win.document.write(`
              <h2>Payslip</h2>
              <p><strong>Name:</strong> ${name}</p>
              <p><strong>Gross Pay:</strong> ${gross.toFixed(2)}</p>
              <p><strong>PAYE:</strong> ${paye.toFixed(2)}</p>
              <p><strong>NSSF:</strong> ${nssf.toFixed(2)}</p>
              <p><strong>SHIF:</strong> ${shif.toFixed(2)}</p>
              <p><strong>AHL:</strong> ${ahl.toFixed(2)}</p>
              <p><strong>Advance:</strong> ${advance.toFixed(2)}</p>
              <p><strong>Total Deductions:</strong> ${total.toFixed(2)}</p>
              <p><strong>Net Pay:</strong> ${net.toFixed(2)}</p>
              <p><strong>NSSF - Employer:</strong> ${nssfEmp.toFixed(2)}</p>
              <p><strong>AHL - Employer:</strong> ${ahlEmp.toFixed(2)}</p>
              <p><strong>NITA:</strong> ${nita.toFixed(2)}</p>
            `);
            win.print();
            win.document.close();
          });

          // Save changes to Firestore
          const savePayroll = () => {
            const payrollData = {
              staffId: staff.id,
              fullName: fullName,
              gross: parseFloat(row.querySelector(".gross").value) || 0,
              paye: parseFloat(row.querySelector(".paye").value) || 0,
              nssf: parseFloat(row.querySelector(".nssf").value) || 0,
              shif: parseFloat(row.querySelector(".shif").value) || 0,
              ahl: parseFloat(row.querySelector(".ahl").value) || 0,
              advance: parseFloat(row.querySelector(".advance").value) || 0,
              totalDeductions: parseFloat(row.querySelector(".total").textContent) || 0,
              netPay: parseFloat(row.querySelector(".net").textContent) || 0,
              nssfEmp: parseFloat(row.querySelector(".nssfEmp").textContent) || 0,
              ahlEmp: parseFloat(row.querySelector(".ahlEmp").textContent) || 0,
              nita: parseFloat(row.querySelector(".nita").textContent) || 0,
              date: new Date().toISOString().split('T')[0]
            };
            payrollCollection.doc(staff.id).set(payrollData, { merge: true }).catch(error => {
              console.error('Error saving payroll:', error);
              showStatus(`Error saving payroll for ${fullName}: ${error.message}.`, "error");
            });
          };

          row.querySelectorAll("input").forEach(input => {
            input.addEventListener("change", savePayroll);
          });
        });

        showStatus("Payroll data loaded successfully", "success");
      } catch (error) {
        console.error('Error loading staff:', error);
        showStatus(`Error loading staff: ${error.message}. Check Firebase rules, network, or data structure.`, "error");
      }
    }

    function downloadPayrollPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Header
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("Consolidated Payroll Report", 105, 15, { align: "center" });
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 22, { align: "center" });

      // Table data
      const headers = [
        "Name", "Gross Pay", "PAYE", "NSSF", "SHIF", "AHL", "Advance", 
        "Total Ded.", "Net Pay", "NSSF-Empl", "AHL-Empl", "NITA"
      ];
      
      const data = [];
      let totals = {
        gross: 0, paye: 0, nssf: 0, shif: 0, ahl: 0, advance: 0,
        totalDeductions: 0, net: 0, nssfEmp: 0, ahlEmp: 0, nita: 0
      };

      document.querySelectorAll("#payrollBody tr").forEach(row => {
        const cols = Array.from(row.querySelectorAll("td")).map(td => {
          const input = td.querySelector("input");
          return input ? input.value : td.textContent.trim();
        }).slice(0, 12);

        data.push(cols);
        
        // Calculate totals
        totals.gross += parseFloat(cols[1]) || 0;
        totals.paye += parseFloat(cols[2]) || 0;
        totals.nssf += parseFloat(cols[3]) || 0;
        totals.shif += parseFloat(cols[4]) || 0;
        totals.ahl += parseFloat(cols[5]) || 0;
        totals.advance += parseFloat(cols[6]) || 0;
        totals.totalDeductions += parseFloat(cols[7]) || 0;
        totals.net += parseFloat(cols[8]) || 0;
        totals.nssfEmp += parseFloat(cols[9]) || 0;
        totals.ahlEmp += parseFloat(cols[10]) || 0;
        totals.nita += parseFloat(cols[11]) || 0;
      });

      // Add totals row
      data.push([
        "TOTALS",
        totals.gross.toFixed(2),
        totals.paye.toFixed(2),
        totals.nssf.toFixed(2),
        totals.shif.toFixed(2),
        totals.ahl.toFixed(2),
        totals.advance.toFixed(2),
        totals.totalDeductions.toFixed(2),
        totals.net.toFixed(2),
        totals.nssfEmp.toFixed(2),
        totals.ahlEmp.toFixed(2),
        totals.nita.toFixed(2)
      ]);

      // Create table
      doc.autoTable({
        head: [headers],
        body: data,
        startY: 30,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [0, 116, 217], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 10, right: 10 },
        columnStyles: {
          0: { cellWidth: 30 }, // Name
          1: { cellWidth: 15 }, // Gross Pay
          2: { cellWidth: 15 }, // PAYE
          3: { cellWidth: 15 }, // NSSF
          4: { cellWidth: 15 }, // SHIF
          5: { cellWidth: 15 }, // AHL
          6: { cellWidth: 15 }, // Advance
          7: { cellWidth: 15 }, // Total Ded.
          8: { cellWidth: 15 }, // Net Pay
          9: { cellWidth: 15 }, // NSSF-Empl
          10: { cellWidth: 15 }, // AHL-Empl
          11: { cellWidth: 15 }  // NITA
        },
        didParseCell: function(data) {
          if (data.row.index === data.table.body.length - 1) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [220, 220, 220];
          }
        }
      });

      // Footer
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(8);
      doc.text(`Page ${doc.getCurrentPageInfo().pageNumber}`, 190, finalY, { align: "right" });

      doc.save("Consolidated_Payroll_Report.pdf");
    }

    function generateBankLetterPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Get current month and year
      const currentDate = new Date();
      const monthNames = ["January", "February", "March", "April", "May", "June", 
                         "July", "August", "September", "October", "November", "December"];
      const month = monthNames[currentDate.getMonth()];
      const year = currentDate.getFullYear();

      // Letter header
      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text(`Date: ${currentDate.toLocaleDateString()}`, 20, 20);
      doc.text("The Manager", 20, 30);
      doc.text("Smep Microfinance Bank", 20, 35); // Replace with actual bank name if available
      doc.text("Ongata Rongai", 20, 40); // Replace with actual branch name if available
      
      // Salutation
      doc.text("Dear Sir/Madam,", 20, 50);
      
      // Reference
      doc.setFont("helvetica", "bold");
      doc.text(`REF: ${month} ${year} Salaries`, 20, 60);
      doc.setFont("helvetica", "normal");
      
      // Introduction
      doc.text("Please process the following salary payments for our staff for the month of", 20, 70);
      doc.text(`${month} ${year}:`, 20, 75);

      // Table data
      const headers = ["Staff Name", "Net Pay"];
      const data = [];
      let totalNetPay = 0;

      document.querySelectorAll("#payrollBody tr").forEach(row => {
        const name = row.cells[0].textContent.trim();
        const netPay = parseFloat(row.querySelector(".net").textContent) || 0;
        data.push([name, netPay.toFixed(2)]);
        totalNetPay += netPay;
      });

      // Add totals row
      data.push(["TOTAL", totalNetPay.toFixed(2)]);

      // Create table
      doc.autoTable({
        head: [headers],
        body: data,
        startY: 85,
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [0, 116, 217], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 20, right: 20 },
        columnStyles: {
          0: { cellWidth: 100 }, // Staff Name
          1: { cellWidth: 60 }   // Net Pay
        },
        didParseCell: function(data) {
          if (data.row.index === data.table.body.length - 1) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [220, 220, 220];
          }
        }
      });

      // Closing
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.text("Please ensure these payments are processed promptly.", 20, finalY);
      doc.text("Thank you for your assistance.", 20, finalY + 5);
      doc.text("Yours faithfully,", 20, finalY + 15);
      doc.text("Jean Mburu", 20, finalY + 25); // Replace with actual sender name

      // Footer
      doc.setFontSize(8);
      doc.text(`Generated by HCS Payroll Module`, 20, finalY + 40);
      doc.text(`Page ${doc.getCurrentPageInfo().pageNumber}`, 190, finalY + 40, { align: "right" });

      doc.save(`Bank_Salary_Letter_${month}_${year}.pdf`);
    }

    // Initialize page
    window.onload = loadPayroll;
  </script>
</body>
</html>
